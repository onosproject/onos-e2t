#!/bin/sh

# SPDX-FileCopyrightText: 2019-present Open Networking Foundation <info@opennetworking.org>
#
# SPDX-License-Identifier: Apache-2.0

usage() {
   echo "This script splits generated by ASN1C tool structure e2ap-v01.00.00.proto into many different files (with regard to their category)."
   echo "Generated files are then located in the same directory, where this script is stored."
   echo "Example of usage:"
   echo "./csplit-protos.sh [-h] fileName"
   echo
   echo "[-h] --> Print this Help."
   echo
   echo "For full compliance with BSD-based OS (like MacOS) please do following:"
   echo "   1) brew install coreutils"
   echo "   2) Uncomment line 33 of this script and use gcsplit instead"
   echo "OR"
   echo "   Uncomment line 32 and observe error each time (but script would work perfectly fine)"
   echo "See more:"
   echo "https://stackoverflow.com/questions/4323703/looking-for-correct-regular-expression-for-csplit"
   exit $1
}

fatal() {
   usage 1
}

[ "$1" = -h ] && usage

[ $# -lt 1 ] && fatal

SPLITFILE=$1 #"e2ap-v01.00.00.proto"

FILESNUMBER=$(csplit -k ${SPLITFILE} '/\/\/\/\/\/[[:space:]][A-Za-z0-9\-]*\.proto/' '{*}' | wc -l)
#FILESNUMBER=$(csplit -k ${SPLITFILE} '/\/\/\/\/\/[[:space:]][A-Za-z0-9\-]*\.proto/' '{999999999}' | wc -l)
#FILESNUMBER=$(gcsplit -k ${SPLITFILE} '/\/\/\/\/\/[[:space:]][A-Za-z0-9\-]*\.proto/' '{*}' | wc -l)
echo "${FILESNUMBER} files were created"

for f in xx*;
do
  FILENAME=$(cat $f | grep -oE '[A-Za-z0-9\-]*\.proto' | awk 'FNR <= 1')
  if [ ! -z "${FILENAME}" ]
  then
    echo "${FILENAME}"
    mv $f $FILENAME
  fi
done
